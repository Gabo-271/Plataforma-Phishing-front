import { useState, useEffect } from 'react';
import { Sidebar } from './components/layout/Sidebar';
import { Dashboard } from './components/dashboard/Dashboard';
import { CampaignList } from './components/campaigns/CampaignList';
import { CreateCampaign } from './components/campaigns/CreateCampaign';
import { TemplateEditor } from './components/templates/TemplateEditor';
import { Settings } from './components/settings/Settings';
import { LandingPage } from './components/landing/LandingPage';
import { Login } from './components/auth/Login';

/**
 * Aplicaci√≥n principal con sistema de autenticaci√≥n Firebase
 * 
 * Configuraci√≥n Firebase requerida en /firebase/config.js:
 * 
 * import { initializeApp } from 'firebase/app';
 * import { getAuth } from 'firebase/auth';
 * 
 * const firebaseConfig = {
 *   apiKey: "tu-api-key",
 *   authDomain: "utem-ciberseguridad.firebaseapp.com",
 *   projectId: "utem-ciberseguridad",
 *   storageBucket: "utem-ciberseguridad.appspot.com",
 *   messagingSenderId: "123456789",
 *   appId: "1:123456789:web:abcdef123456"
 * };
 * 
 * const app = initializeApp(firebaseConfig);
 * export const auth = getAuth(app);
 */

interface User {
  uid: string;
  email: string;
  displayName: string;
  role: string;
  department: string;
  lastLogin: string;
}

export default function App() {
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [isCreatingCampaign, setIsCreatingCampaign] = useState(false);
  const [user, setUser] = useState<User | null>(null);
  const [authLoading, setAuthLoading] = useState(true);

  // Simulaci√≥n de verificaci√≥n de autenticaci√≥n al cargar la app
  useEffect(() => {
    const checkAuthState = () => {
      // TODO: Implementar Firebase Auth state listener
      // import { onAuthStateChanged } from 'firebase/auth';
      // import { auth } from './firebase/config';
      // 
      // const unsubscribe = onAuthStateChanged(auth, (firebaseUser) => {
      //   if (firebaseUser) {
      //     setUser({
      //       uid: firebaseUser.uid,
      //       email: firebaseUser.email || '',
      //       displayName: firebaseUser.displayName || 'Usuario UTEM',
      //       role: 'admin', // Obtener de Firestore o custom claims
      //       department: 'Ciberseguridad',
      //       lastLogin: new Date().toISOString()
      //     });
      //   } else {
      //     setUser(null);
      //   }
      //   setAuthLoading(false);
      // });
      // 
      // return unsubscribe;

      // Simulaci√≥n para desarrollo - verificar localStorage
      const savedUser = localStorage.getItem('utem-user');
      if (savedUser) {
        try {
          setUser(JSON.parse(savedUser));
        } catch (error) {
          console.error('Error parsing saved user:', error);
          localStorage.removeItem('utem-user');
        }
      }
      setAuthLoading(false);
    };

    checkAuthState();
  }, []);

  const handleLogin = (userData: User) => {
    setUser(userData);
    // Guardar en localStorage para persistencia de desarrollo
    localStorage.setItem('utem-user', JSON.stringify(userData));
  };

  const handleLogout = () => {
    // TODO: Implementar Firebase signOut
    // import { signOut } from 'firebase/auth';
    // import { auth } from './firebase/config';
    // 
    // signOut(auth).then(() => {
    //   setUser(null);
    //   localStorage.removeItem('utem-user');
    // });

    // Simulaci√≥n para desarrollo
    setUser(null);
    localStorage.removeItem('utem-user');
    setCurrentPage('dashboard');
  };

  // Simulaci√≥n de diferentes vistas basadas en URL params
  const urlParams = new URLSearchParams(window.location.search);
  const isLandingPage = urlParams.get('landing') === 'true';
  
  if (isLandingPage) {
    return <LandingPage campaignId={urlParams.get('c') || 'demo'} userId={urlParams.get('u') || 'demo'} />;
  }

  // Mostrar loading mientras se verifica la autenticaci√≥n
  if (authLoading) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center space-y-4">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
          <p className="text-muted-foreground">Verificando autenticaci√≥n...</p>
        </div>
      </div>
    );
  }

  // Mostrar login si no hay usuario autenticado
  if (!user) {
    return <Login onLogin={handleLogin} />;
  }

  const renderMainContent = () => {
    if (currentPage === 'campaigns' && isCreatingCampaign) {
      return <CreateCampaign />;
    }

    switch (currentPage) {
      case 'dashboard':
        return <Dashboard />;
      case 'campaigns':
        return <CampaignList />;
      case 'detection':
        return (
          <div className="p-6">
            <h1>M√≥dulo de Detecci√≥n</h1>
            <p className="text-muted-foreground mt-2">
              Sistema avanzado de detecci√≥n y an√°lisis de amenazas en desarrollo...
            </p>
            <div className="mt-8 p-4 bg-muted rounded-lg">
              <h3 className="font-medium mb-2">üõ°Ô∏è Funcionalidades Planificadas</h3>
              <ul className="text-sm text-muted-foreground space-y-1">
                <li>‚Ä¢ Detecci√≥n autom√°tica de emails de phishing</li>
                <li>‚Ä¢ An√°lisis de URLs maliciosas en tiempo real</li>
                <li>‚Ä¢ Monitoreo de dominios sospechosos</li>
                <li>‚Ä¢ Alertas tempranas de amenazas</li>
                <li>‚Ä¢ Dashboard de inteligencia de amenazas</li>
                <li>‚Ä¢ Integraci√≥n con feeds de amenazas externos</li>
                <li>‚Ä¢ An√°lisis de reputaci√≥n de remitentes</li>
                <li>‚Ä¢ Sistema de scoring de riesgo</li>
              </ul>
            </div>
            <div className="mt-6 p-4 bg-accent/10 border border-accent/20 rounded-lg">
              <h3 className="font-medium mb-2 text-accent-foreground">üìä Endpoints de API</h3>
              <ul className="text-sm text-muted-foreground space-y-1 font-mono">
                <li>‚Ä¢ POST /api/detection/analyze-email</li>
                <li>‚Ä¢ GET /api/detection/threats/&#123;id&#125;</li>
                <li>‚Ä¢ POST /api/detection/url-scan</li>
                <li>‚Ä¢ GET /api/detection/dashboard</li>
                <li>‚Ä¢ POST /api/detection/threat-feed</li>
              </ul>
            </div>
          </div>
        );
      case 'templates':
        return <TemplateEditor />;
      case 'settings':
      case 'account':
        return <Settings />;
      case 'users':
        return (
          <div className="p-6">
            <h1>Usuarios y Grupos</h1>
            <p className="text-muted-foreground mt-2">
              M√≥dulo de gesti√≥n de usuarios en desarrollo...
            </p>
            <div className="mt-8 p-4 bg-muted rounded-lg">
              <h3 className="font-medium mb-2">üîß Funcionalidades Planificadas</h3>
              <ul className="text-sm text-muted-foreground space-y-1">
                <li>‚Ä¢ Crear y gestionar grupos de usuarios</li>
                <li>‚Ä¢ Importar usuarios desde CSV/LDAP</li>
                <li>‚Ä¢ Asignar roles y permisos</li>
                <li>‚Ä¢ Historial de participaci√≥n en campa√±as</li>
              </ul>
            </div>
          </div>
        );
      case 'landing':
        return (
          <div className="p-6">
            <h1>P√°ginas de Destino</h1>
            <p className="text-muted-foreground mt-2">
              Editor de landing pages educativas en desarrollo...
            </p>
            <div className="mt-8 p-4 bg-muted rounded-lg">
              <h3 className="font-medium mb-2">üîß Funcionalidades Planificadas</h3>
              <ul className="text-sm text-muted-foreground space-y-1">
                <li>‚Ä¢ Editor visual de landing pages</li>
                <li>‚Ä¢ Plantillas de p√°ginas educativas</li>
                <li>‚Ä¢ Captura de credenciales (para entrenamiento)</li>
                <li>‚Ä¢ M√©tricas de interacci√≥n</li>
              </ul>
            </div>
          </div>
        );
      case 'sending':
        return (
          <div className="p-6">
            <h1>Perfiles de Env√≠o</h1>
            <p className="text-muted-foreground mt-2">
              Gesti√≥n avanzada de perfiles SMTP en desarrollo...
            </p>
            <div className="mt-8 p-4 bg-muted rounded-lg">
              <h3 className="font-medium mb-2">üîß Funcionalidades Planificadas</h3>
              <ul className="text-sm text-muted-foreground space-y-1">
                <li>‚Ä¢ Configuraci√≥n detallada de SMTP</li>
                <li>‚Ä¢ Pruebas de entregabilidad</li>
                <li>‚Ä¢ Monitoreo de reputaci√≥n</li>
                <li>‚Ä¢ Rotaci√≥n autom√°tica de servidores</li>
              </ul>
            </div>
          </div>
        );
      case 'management':
        return (
          <div className="p-6">
            <h1>Gesti√≥n de Usuarios</h1>
            <p className="text-muted-foreground mt-2">
              Panel administrativo en desarrollo...
            </p>
            <div className="mt-8 p-4 bg-muted rounded-lg">
              <h3 className="font-medium mb-2">üîß Funcionalidades Planificadas</h3>
              <ul className="text-sm text-muted-foreground space-y-1">
                <li>‚Ä¢ Gesti√≥n de roles: autor, revisor, aprobador, admin</li>
                <li>‚Ä¢ Flujo de aprobaciones pendientes</li>
                <li>‚Ä¢ Auditoria de acciones</li>
                <li>‚Ä¢ Configuraci√≥n de permisos granulares</li>
              </ul>
            </div>
          </div>
        );
      case 'webhooks':
        return (
          <div className="p-6">
            <h1>Webhooks</h1>
            <p className="text-muted-foreground mt-2">
              Configuraci√≥n de webhooks y integraciones en desarrollo...
            </p>
            <div className="mt-8 p-4 bg-muted rounded-lg">
              <h3 className="font-medium mb-2">üîß Funcionalidades Planificadas</h3>
              <ul className="text-sm text-muted-foreground space-y-1">
                <li>‚Ä¢ Webhooks para eventos de campa√±a</li>
                <li>‚Ä¢ Integraci√≥n con Slack/Teams</li>
                <li>‚Ä¢ Notificaciones en tiempo real</li>
                <li>‚Ä¢ API para sistemas externos</li>
              </ul>
            </div>
          </div>
        );
      case 'guide':
        return (
          <div className="p-6">
            <h1>Gu√≠a de Usuario</h1>
            <p className="text-muted-foreground mt-2">
              Documentaci√≥n y tutoriales en desarrollo...
            </p>
          </div>
        );
      case 'api':
        return (
          <div className="p-6">
            <h1>Documentaci√≥n API</h1>
            <p className="text-muted-foreground mt-2">
              Referencia completa de la API en desarrollo...
            </p>
          </div>
        );
      default:
        return <Dashboard />;
    }
  };

  return (
    <div className="min-h-screen bg-background flex">
      <Sidebar 
        currentPage={currentPage} 
        onPageChange={setCurrentPage}
        user={user}
        onLogout={handleLogout}
      />
      <main className="flex-1 overflow-auto">
        {renderMainContent()}
      </main>
    </div>
  );
}